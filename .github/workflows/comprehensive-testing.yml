name: Comprehensive Testing

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - validation
          - publishing
      verbose:
        description: 'Enable verbose output'
        required: false
        default: false
        type: boolean

jobs:
  setup-test-data:
    runs-on: ubuntu-latest
    outputs:
      test-policies: ${{ steps.setup.outputs.test-policies }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test data
        id: setup
        run: |
          # Create test policy structures
          mkdir -p test/policies

          # Test Policy 1: Valid complete policy
          mkdir -p test/policies/test-policy-1/v1.0.0/{src,docs}
          cat > test/policies/test-policy-1/v1.0.0/metadata.json << 'EOF'
          {
            "name": "test-policy-1",
            "displayName": "Test Policy 1",
            "provider": "test-provider",
            "categories": ["security", "compliance"],
            "description": "A test policy for validation",
            "version": "v1.0.0"
          }
          EOF

          cat > test/policies/test-policy-1/v1.0.0/policy-definition.yaml << 'EOF'
          apiVersion: policy/v1
          kind: Policy
          metadata:
            name: test-policy-1
          spec:
            rules:
              - name: test-rule
                condition: "true"
                action: allow
          EOF

          cat > test/policies/test-policy-1/v1.0.0/src/main.go << 'EOF'
          package main

          import "fmt"

          func main() {
              fmt.Println("Hello from test-policy-1")
          }
          EOF

          cat > test/policies/test-policy-1/v1.0.0/docs/overview.md << 'EOF'
          # Test Policy 1 Overview

          This is a test policy for comprehensive validation.
          EOF

          cat > test/policies/test-policy-1/v1.0.0/docs/configuration.md << 'EOF'
          # Configuration

          ## Parameters
          - enabled: Enable the policy (default: true)
          EOF

          cat > test/policies/test-policy-1/v1.0.0/docs/examples.md << 'EOF'
          # Examples

          Basic usage example for test-policy-1.
          EOF

          # Test Policy 2: Valid policy with assets
          mkdir -p test/policies/test-policy-2/v1.0.0/{src,docs,assets}
          cat > test/policies/test-policy-2/v1.0.0/metadata.json << 'EOF'
          {
            "name": "test-policy-2",
            "displayName": "Test Policy 2",
            "provider": "test-provider",
            "categories": ["monitoring"],
            "description": "Another test policy with assets",
            "version": "v1.0.0"
          }
          EOF

          cat > test/policies/test-policy-2/v1.0.0/policy-definition.yaml << 'EOF'
          apiVersion: policy/v1
          kind: Policy
          metadata:
            name: test-policy-2
          spec:
            rules:
              - name: monitor-rule
                condition: "resource.type == 'vm'"
                action: monitor
          EOF

          cat > test/policies/test-policy-2/v1.0.0/src/main.go << 'EOF'
          package main

          func main() {
              // Monitoring policy
          }
          EOF

          cat > test/policies/test-policy-2/v1.0.0/docs/overview.md << 'EOF'
          # Test Policy 2 Overview

          Monitoring policy with assets.
          EOF

          cat > test/policies/test-policy-2/v1.0.0/docs/configuration.md << 'EOF'
          # Configuration

          Monitoring configuration.
          EOF

          cat > test/policies/test-policy-2/v1.0.0/docs/examples.md << 'EOF'
          # Examples

          Monitoring examples.
          EOF

          echo "test-policy-1,test-policy-2" > test-policy-assets.txt

          # Create invalid test cases
          mkdir -p test/policies/invalid-policy-missing-docs/v1.0.0/{src}
          cat > test/policies/invalid-policy-missing-docs/v1.0.0/metadata.json << 'EOF'
          {
            "name": "invalid-policy-missing-docs",
            "displayName": "Invalid Policy",
            "provider": "test-provider",
            "categories": ["test"],
            "description": "Invalid policy missing docs",
            "version": "v1.0.0"
          }
          EOF

          cat > test/policies/invalid-policy-missing-docs/v1.0.0/src/main.go << 'EOF'
          package main
          func main() {}
          EOF

          echo "Test data setup complete"

  unit-tests:
    needs: setup-test-data
    runs-on: ubuntu-latest
    if: ${{ inputs.test_type == 'all' || inputs.test_type == 'unit' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test data
        run: |
          mkdir -p test/policies
          cp -r test/policies/* policies/ || true

      - name: Test prepare-zip.sh - Valid policy
        run: |
          cd test
          if ../scripts/prepare-zip.sh test-policy-1 v1.0.0; then
            echo "‚úÖ prepare-zip.sh succeeded for valid policy"
            if [ -f "test-policy-1-v1.0.0.zip" ]; then
              echo "‚úÖ ZIP file created"
              # Verify ZIP contents
              unzip -l test-policy-1-v1.0.0.zip | grep -q "metadata.json" && echo "‚úÖ Contains metadata.json" || (echo "‚ùå Missing metadata.json" && exit 1)
              unzip -l test-policy-1-v1.0.0.zip | grep -q "docs/overview.md" && echo "‚úÖ Contains docs" || (echo "‚ùå Missing docs" && exit 1)
              unzip -l test-policy-1-v1.0.0.zip | grep -q "src/main.go" && echo "‚úÖ Contains source" || (echo "‚ùå Missing source" && exit 1)
            else
              echo "‚ùå ZIP file not created"
              exit 1
            fi
          else
            echo "‚ùå prepare-zip.sh failed for valid policy"
            exit 1
          fi

      - name: Test prepare-zip.sh - Invalid inputs
        run: |
          cd test
          # Test invalid policy name
          if ../scripts/prepare-zip.sh "test policy" v1.0.0 2>/dev/null; then
            echo "‚ùå Should have failed with invalid policy name"
            exit 1
          else
            echo "‚úÖ Correctly rejected invalid policy name"
          fi

          # Test invalid version
          if ../scripts/prepare-zip.sh test-policy-1 "1.0.0" 2>/dev/null; then
            echo "‚ùå Should have failed with invalid version"
            exit 1
          else
            echo "‚úÖ Correctly rejected invalid version"
          fi

          # Test missing policy
          if ../scripts/prepare-zip.sh nonexistent v1.0.0 2>/dev/null; then
            echo "‚ùå Should have failed with missing policy"
            exit 1
          else
            echo "‚úÖ Correctly failed with missing policy"
          fi

      - name: Test validate-config.sh - Valid config
        run: |
          if ./scripts/validate-config.sh; then
            echo "‚úÖ validate-config.sh succeeded with valid config"
          else
            echo "‚ùå validate-config.sh failed with valid config"
            exit 1
          fi

      - name: Test validate-config.sh - Invalid JSON
        run: |
          echo '{"invalid": json' > config/test-config.json
          mv config/policy-hub-config.json config/policy-hub-config.json.backup
          mv config/test-config.json config/policy-hub-config.json
          if ./scripts/validate-config.sh 2>/dev/null; then
            echo "‚ùå Should have failed with invalid JSON"
            exit 1
          else
            echo "‚úÖ Correctly rejected invalid JSON"
          fi
        finally:
          mv config/policy-hub-config.json.backup config/policy-hub-config.json || true

      - name: Cleanup
        run: rm -rf test/policies/*.zip

  validation-tests:
    needs: setup-test-data
    runs-on: ubuntu-latest
    if: ${{ inputs.test_type == 'all' || inputs.test_type == 'validation' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test data
        run: |
          mkdir -p test/policies
          cp -r test/policies/* policies/ || true

      - name: Test PR validation logic - Valid policy
        run: |
          # Simulate PR validation checks
          echo "Testing policy structure validation..."

          # Check for required files
          if [ ! -f "policies/test-policy-1/v1.0.0/metadata.json" ]; then
            echo "‚ùå Missing metadata.json"
            exit 1
          fi
          if [ ! -f "policies/test-policy-1/v1.0.0/policy-definition.yaml" ]; then
            echo "‚ùå Missing policy-definition.yaml"
            exit 1
          fi
          if [ ! -d "policies/test-policy-1/v1.0.0/src" ]; then
            echo "‚ùå Missing src directory"
            exit 1
          fi
          if [ ! -d "policies/test-policy-1/v1.0.0/docs" ]; then
            echo "‚ùå Missing docs directory"
            exit 1
          fi

          # Check docs files
          for doc in overview.md configuration.md examples.md; do
            if [ ! -f "policies/test-policy-1/v1.0.0/docs/$doc" ]; then
              echo "‚ùå Missing docs/$doc"
              exit 1
            fi
          done

          # Validate metadata.json
          if ! jq -e '.name and .displayName and .provider and .categories and .description and .version' policies/test-policy-1/v1.0.0/metadata.json > /dev/null; then
            echo "‚ùå metadata.json missing required fields"
            exit 1
          fi

          echo "‚úÖ Valid policy structure"

      - name: Test PR validation logic - Invalid policy
        run: |
          echo "Testing invalid policy detection..."

          # Test missing docs
          if [ -f "policies/invalid-policy-missing-docs/v1.0.0/docs/overview.md" ]; then
            echo "‚ùå Should not have docs files for invalid policy"
            exit 1
          fi

          # This should fail validation
          if [ -f "policies/invalid-policy-missing-docs/v1.0.0/docs/overview.md" ] && \
             [ -f "policies/invalid-policy-missing-docs/v1.0.0/docs/configuration.md" ] && \
             [ -f "policies/invalid-policy-missing-docs/v1.0.0/docs/examples.md" ]; then
            echo "‚ùå Invalid policy should not pass docs validation"
            exit 1
          else
            echo "‚úÖ Correctly identified invalid policy (missing docs)"
          fi

  action-tests:
    needs: setup-test-data
    runs-on: ubuntu-latest
    if: ${{ inputs.test_type == 'all' || inputs.test_type == 'unit' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test data
        run: |
          mkdir -p test/policies
          cp -r test/policies/* policies/ || true

      - name: Test detect-versions action
        uses: ./.github/actions/detect-versions
        id: detect
        with:
          policy-path: policies

      - name: Verify detect-versions output
        run: |
          echo "Detected versions: ${{ steps.detect.outputs.versions }}"
          if [ -z "${{ steps.detect.outputs.versions }}" ]; then
            echo "‚ùå detect-versions action returned empty result"
            exit 1
          fi

          # Check if our test policies are detected
          if echo "${{ steps.detect.outputs.versions }}" | grep -q "test-policy-1"; then
            echo "‚úÖ detect-versions found test-policy-1"
          else
            echo "‚ùå detect-versions missed test-policy-1"
            exit 1
          fi

          if echo "${{ steps.detect.outputs.versions }}" | grep -q "test-policy-2"; then
            echo "‚úÖ detect-versions found test-policy-2"
          else
            echo "‚ùå detect-versions missed test-policy-2"
            exit 1
          fi

  integration-tests:
    needs: [setup-test-data, unit-tests]
    runs-on: ubuntu-latest
    if: ${{ inputs.test_type == 'all' || inputs.test_type == 'integration' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test data
        run: |
          mkdir -p test/policies
          cp -r test/policies/* policies/ || true

      - name: Test complete workflow - Create ZIPs
        run: |
          # Test the complete prepare-zip workflow
          ./scripts/prepare-zip.sh test-policy-1 v1.0.0
          ./scripts/prepare-zip.sh test-policy-2 v1.0.0

          # Verify ZIPs created
          if [ ! -f "test-policy-1-v1.0.0.zip" ] || [ ! -f "test-policy-2-v1.0.0.zip" ]; then
            echo "‚ùå ZIP files not created"
            exit 1
          fi

          echo "‚úÖ All ZIP files created successfully"

      - name: Test publishing workflow simulation
        run: |
          # Simulate the publishing workflow
          echo "Simulating publishing workflow..."

          # Check if we have the required secrets/variables (simulate)
          if [ -z "$AWS_ACCESS_KEY_ID" ]; then
            echo "‚ö†Ô∏è  AWS_ACCESS_KEY_ID not set (expected in real workflow)"
          fi

          if [ -z "$POLICY_HUB_API_URL" ]; then
            echo "‚ö†Ô∏è  POLICY_HUB_API_URL not set (expected in real workflow)"
          fi

          echo "‚úÖ Publishing workflow simulation complete"

  publishing-tests:
    needs: [setup-test-data, integration-tests]
    runs-on: ubuntu-latest
    if: ${{ inputs.test_type == 'all' || inputs.test_type == 'publishing' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test data
        run: |
          mkdir -p test/policies
          cp -r test/policies/* policies/ || true

      - name: Test publish-policy action (dry run)
        uses: ./.github/actions/publish-policy
        with:
          policy-name: test-policy-1
          policy-version: v1.0.0
          s3-bucket: test-bucket
          api-url: https://api.test-policy-hub.com
          dry-run: true

      - name: Verify dry run results
        run: |
          # In a dry run, the action should not actually publish
          # but should validate inputs and prepare payloads
          echo "‚úÖ publish-policy dry run completed"

  cleanup:
    needs: [unit-tests, validation-tests, action-tests, integration-tests, publishing-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Cleanup test artifacts
        run: |
          rm -rf test/
          rm -f *.zip
          echo "üßπ Test cleanup completed"

      - name: Test Results Summary
        run: |
          echo "## Test Results Summary"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Validation Tests: ${{ needs.validation-tests.result }}"
          echo "Action Tests: ${{ needs.action-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Publishing Tests: ${{ needs.publishing-tests.result }}"

          if [[ "${{ needs.unit-tests.result }}" == "success" && \
                "${{ needs.validation-tests.result }}" == "success" && \
                "${{ needs.action-tests.result }}" == "success" && \
                "${{ needs.integration-tests.result }}" == "success" && \
                "${{ needs.publishing-tests.result }}" == "success" ]]; then
            echo "üéâ All tests passed!"
          else
            echo "‚ùå Some tests failed. Check the logs above."
            exit 1
          fi